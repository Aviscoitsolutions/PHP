!function(p){p(function(){MPHB.BookingsCalendar=can.Control.extend({},{filtersForm:null,customPeriodWrapper:null,btnPeriodPrev:null,btnPeriodNext:null,periodEl:null,init:function(e,t){this.filtersForm=this.element.find("#mphb-bookings-calendar-filters"),this.customPeriodWrapper=this.filtersForm.find(".mphb-custom-period-wrapper"),this.btnPeriodPrev=this.filtersForm.find(".mphb-period-prev"),this.btnPeriodNext=this.filtersForm.find(".mphb-period-next"),this.periodEl=this.filtersForm.find("#mphb-bookings-calendar-filter-period"),this.searchDateFromEl=this.filtersForm.find(".mphb-search-date-from"),this.searchDateToEl=this.filtersForm.find(".mphb-search-date-to"),this.initDatepickers()},initDatepickers:function(){this.filtersForm.find(".mphb-datepick").datepick({dateFormat:MPHB.Plugin.myThis.data.settings.dateFormat,showSpeed:0,showOtherMonths:!0,monthsToShow:MPHB.Plugin.myThis.data.settings.numberOfMonthDatepicker,pickerClass:MPHB.Plugin.myThis.data.settings.datepickerClass})},"#mphb-bookings-calendar-filter-period change":function(e,t){"custom"===p(e).val()?(this.customPeriodWrapper.removeClass("mphb-hide"),this.btnPeriodNext.addClass("mphb-hide"),this.btnPeriodPrev.addClass("mphb-hide")):(this.customPeriodWrapper.addClass("mphb-hide"),this.btnPeriodNext.removeClass("mphb-hide"),this.btnPeriodPrev.removeClass("mphb-hide"))},"#mphb-booking-calendar-search-room-availability-status change":function(e,t){""===p(e).val()?(this.searchDateFromEl.addClass("mphb-hide"),this.searchDateToEl.addClass("mphb-hide")):(this.searchDateFromEl.removeClass("mphb-hide"),this.searchDateToEl.removeClass("mphb-hide"))}}),MPHB.format_price=function(e,t){t=t||{};var i=MPHB.Plugin.myThis.data.settings.currency;t=p.extend({trim_zeros:!1},i,t),e=MPHB.number_format(e,t.decimals,t.decimal_separator,t.thousand_separator);var n=t.price_format.replace("%s",e);if(t.trim_zeros){var r=new RegExp("\\"+t.decimal_separator+"0+$|(\\"+t.decimal_separator+"\\d*[1-9])0+$");n=n.replace(r,"$1")}return'<span class="mphb-price">'+n+"</span>"},MPHB.format_percentage=function(e,t){t=t||{};var i=MPHB.Plugin.myThis.data.settings.currency;return t=p.extend({},i,t),'<span class="mphb-percentage">'+((e=MPHB.number_format(e,t.decimals,t.decimal_separator,t.thousand_separator))+"%")+"</span>"},MPHB.number_format=function(e,t,i,n){var r,a,s="";return t=t||0,i=i||".",n=n||",",e<0&&(s="-",e*=-1),3<(a=(r=parseInt(e=(+e||0).toFixed(t))+"").length)?a%=3:a=0,s+(a?r.substr(0,a)+n:"")+r.substr(a).replace(/(\d{3})(?=\d)/g,"$1"+n)+(t?i+Math.abs(e-r).toFixed(t).replace(/-/,0).slice(2):"")},MPHB.Plugin=can.Construct.extend({myThis:null},{data:null,init:function(e,t){(MPHB.Plugin.myThis=this).data=MPHB._data,delete MPHB._data;var i=p(".mphb-ctrl:not([data-inited])");this.setControls(i)},getVersion:function(){return this.data.version},getPrefix:function(){return this.data.prefix},addPrefix:function(e,t){return t=void 0!==t?t:"-",this.getPrefix()+t+e},setControls:function(e){p.each(e,function(){switch(p(this).attr("data-type")){case"text":break;case"number":new MPHB.NumberCtrl(p(this));break;case"total-price":new MPHB.TotalPriceCtrl(p(this));break;case"price-breakdown":new MPHB.PriceBreakdownCtrl(p(this));break;case"gallery":new MPHB.GalleryCtrl(p(this));break;case"datepicker":new MPHB.DatePickerCtrl(p(this));break;case"color-picker":new MPHB.ColorPickerCtrl(p(this));break;case"complex":new MPHB.ComplexCtrl(p(this));break;case"complex-vertical":new MPHB.ComplexVerticalCtrl(p(this));break;case"dynamic-select":new MPHB.DynamicSelectCtrl(p(this));break;case"multiple-checkbox":new MPHB.MultipleCheckboxCtrl(p(this));break;case"amount":new MPHB.AmountCtrl(p(this));break;case"rules-list":new MPHB.RulesListCtrl(p(this));break;case"variable-pricing":new MPHB.VariablePricingCtrl(p(this))}p(this).attr("data-inited",!0)})}}),MPHB.WPGallery=can.Construct.extend({myThis:null,getInstance:function(){return null===MPHB.WPGallery.myThis&&(MPHB.WPGallery.myThis=new MPHB.WPGallery),MPHB.WPGallery.myThis}},{frame:null,ctrl:null,init:function(){MPHB.WPGallery.myThis=this,Attachment=wp.media.model.Attachment,wp.media.controller.MPHBGallery=wp.media.controller.FeaturedImage.extend({defaults:parent._.defaults({id:"mphb-media-library-gallery",title:MPHB.Plugin.myThis.data.translations.roomTypeGalleryTitle,toolbar:"main-insert",filterable:"uploaded",library:wp.media.query({type:"image"}),multiple:"add",editable:!0,priority:60,syncSelection:!1},wp.media.controller.Library.prototype.defaults),updateSelection:function(){var e,t=this.get("selection"),i=MPHB.WPGallery.myThis.ctrl.get();""!==i&&-1!==i&&(e=parent._.map(i.split(/,/),function(e){return Attachment.get(e)})),t.reset(e)}}),wp.media.view.MediaFrame.MPHBGallery=wp.media.view.MediaFrame.Post.extend({createStates:function(){this.options;this.states.add([new wp.media.controller.MPHBGallery])},bindHandlers:function(){wp.media.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("toolbar:create:main-insert",this.createToolbar,this);parent._.each({content:{embed:"embedContent","edit-selection":"editSelectionContent"},toolbar:{"main-insert":"mainInsertToolbar"}},function(e,i){parent._.each(e,function(e,t){this.on(i+":render:"+t,this[e],this)},this)},this)},mainInsertToolbar:function(e){var i=this;this.selectionStatusToolbar(e),e.set("insert",{style:"primary",priority:80,text:MPHB.Plugin.myThis.data.translations.addGalleryToRoomType,requires:{selection:!0},click:function(){var e=i.state(),t=e.get("selection");i.close(),e.trigger("insert",t).reset()}})}}),this.frame=new wp.media.view.MediaFrame.MPHBGallery(parent._.defaults({},{state:"mphb-media-library-gallery",library:{type:"image"},multiple:!0})),this.frame.on("open",this.proxy("onOpen")),this.frame.on("insert",this.proxy("setImage"))},open:function(e){this.ctrl=e,this.frame.open()},onOpen:function(){var t=this.frame;t.reset();var e=this.ctrl.getArray();if(e.length){var i=null;e.forEach(function(e){(i=wp.media.attachment(e)).fetch(),t.state().get("selection").add(i)})}},setImage:function(){var n=[],e=this.frame.state().get("selection").models;p.each(e,function(e,t){var i=t.attributes;n.push(i.id)}),this.ctrl.set(n.join(","))}}),MPHB.Ctrl=can.Control.extend({renderValue:function(e){var t=e.attr("data-type");return e.find('input[type="'+t+'"]').val()}},{parentForm:null,init:function(e,t){this.parentForm=this.element.closest("form")}}),MPHB.AmountCtrl=MPHB.Ctrl.extend({renderValue:function(e){var t=e.find('input[type="number"]:not(:disabled)'),i="price"==e.children(".mphb-amount-inputs").attr("data-render-type")?MPHB.format_price:MPHB.format_percentage;if(1==t.length)return i(t.val());var n=MPHB.Plugin.myThis.data.translations.adults;return n+=i(p(t[0]).val()),n+="<br />"+MPHB.Plugin.myThis.data.translations.children,n+=i(p(t[1]).val())}},{mainWrapper:null,singleInputGroup:null,multipleInputsGroup:null,commonAmountInput:null,adultsAmountInput:null,childrenAmountInput:null,dependencyCtrl:null,singleInputTriggers:[],multipleInputsTriggers:[],init:function(e,t){this._super(e,t),this.mainWrapper=this.element.children(".mphb-amount-inputs"),this.singleInputGroup=this.mainWrapper.children(".mphb-amount-single-input-group"),this.multipleInputsGroup=this.mainWrapper.children(".mphb-amount-multiple-inputs-group"),this.commonAmountInput=this.singleInputGroup.find("input.mphb-amount-common-input"),this.adultsAmountInput=this.multipleInputsGroup.find("input.mphb-amount-adults-input"),this.childrenAmountInput=this.multipleInputsGroup.find("input.mphb-amount-children-input");var i=this.mainWrapper.attr("data-dependency");if(i){var n=this;this.dependencyCtrl=this.element.closest("form").find('[name="'+i+'"]'),this.dependencyCtrl.on("change",function(e){var t=p(this).val();n.onTrigger(t)})}this.singleInputTriggers=this.mainWrapper.attr("data-single-triggers").split(","),this.multipleInputsTriggers=this.mainWrapper.attr("data-multiple-triggers").split(",")},onTrigger:function(e){var t=-1!=this.singleInputTriggers.indexOf(e),i=-1!=this.multipleInputsTriggers.indexOf(e);-1!=e.indexOf("percent")?this.mainWrapper.attr("data-render-type","percentage"):this.mainWrapper.attr("data-render-type","price"),t?this.switchToSingleInput():i&&this.switchToMultipleInputs()},switchToSingleInput:function(){this.adultsAmountInput.prop("disabled",!0),this.childrenAmountInput.prop("disabled",!0),this.commonAmountInput.prop("disabled",!1),this.multipleInputsGroup.addClass("mphb-hide"),this.singleInputGroup.removeClass("mphb-hide")},switchToMultipleInputs:function(){this.commonAmountInput.prop("disabled",!0),this.adultsAmountInput.prop("disabled",!1),this.childrenAmountInput.prop("disabled",!1),this.singleInputGroup.addClass("mphb-hide"),this.multipleInputsGroup.removeClass("mphb-hide")}}),MPHB.ColorPickerCtrl=MPHB.Ctrl.extend({},{input:null,init:function(e,t){this._super(e,t),this.input=this.element.find("input"),this.input.spectrum({allowEmpty:!0,preferredFormat:"hex",showInput:!0,showInitial:!0,showAlpha:!1})}}),MPHB.ComplexCtrl=MPHB.Ctrl.extend({},{prototypeItem:null,itemsHolder:null,lastIndex:null,uniqid:null,itemSelector:"tr",metaName:null,init:function(e,t){this._super(e,t),this.uniqid=this.element.children("table").attr("data-uniqid"),this.metaName=this.element.children('input[type="hidden"]:first-of-type').attr("name"),this.initItemsHolder(),this.initAddBtn(),this.initDeleteBtns(),this.preparePrototypeItem(),this.initLastIndex(),this.setKeys(this.itemsHolder.children(this.itemSelector))},makeItemsHolderSortable:function(){this.itemsHolder.sortable()},initLastIndex:function(){this.lastIndex=0;var i=this;this.itemsHolder.children(this.itemSelector).each(function(e,t){i.lastIndex=Math.max(i.lastIndex,parseInt(p(t).attr("data-id")))})},initItemsHolder:function(){this.itemsHolder=this.element.children("table").children("tbody"),this.itemsHolder.hasClass("mphb-sortable")&&this.makeItemsHolderSortable()},initAddBtn:function(){var t=this;this.element.on("click",'.mphb-complex-add-item[data-id="'+this.uniqid+'"]',function(e){e.preventDefault(),t.addItem()})},initDeleteBtns:function(){var t=this;this.itemsHolder.on("click",'.mphb-complex-delete-item[data-id="'+this.uniqid+'"]',function(e){e.preventDefault(),t.deleteItem(p(this).closest(t.itemSelector))})},preparePrototypeItem:function(){var e=this.itemsHolder.children(".mphb-complex-item-prototype");this.prototypeItem=e.clone(),this.prototypeItem.removeClass("mphb-hide mphb-complex-item-prototype").find("[name]:not(.mphb-keep-disabled)").each(function(){p(this).removeAttr("disabled")}),e.remove()},getIncIndex:function(){return++this.lastIndex},setKeys:function(e){var i,n,r,a,s,l,o=this,d=new RegExp("%key_"+this.uniqid+"%","g"),h="%key_"+this.uniqid+"%";e.each(function(e,t){l=p(t),(a=l.attr("data-id"))===h&&(a=o.getIncIndex(),l.attr("data-id",a)),l.find('[name*="[%key_'+o.uniqid+'%]"]').each(function(){i=p(this).attr("name").replace(d,a),p(this).attr("name",i),p(this).attr("id")&&(n=p(this).attr("id").replace(d,a).replace(/\[|\]/g,"__"),p(this).attr("name",i).attr("id",n))}),l.find('[for*="[%key_'+o.uniqid+'%]"]').each(function(){r=p(this).attr("for").replace(d,a).replace(/\[|\]/g,"__"),p(this).attr("for",r)}),l.find('[data-dependency*="%key_'+o.uniqid+'%"]').each(function(){s=p(this).attr("data-dependency").replace(d,a),p(this).attr("data-dependency",s)})})},clonePrototypeItem:function(){var e=this.prototypeItem.clone();return this.setKeys(e),e},addItemToHolder:function(e){this.itemsHolder.append(e)},deleteItem:function(e){e.remove()},addItem:function(){var e=this.clonePrototypeItem();this.addItemToHolder(e);var t=e.find(".mphb-ctrl:not([data-inited])");MPHB.Plugin.myThis.setControls(t)}}),MPHB.ComplexVerticalCtrl=MPHB.ComplexCtrl.extend({},{itemSelector:"tbody",lastIndexInput:null,minItemsCount:0,init:function(e,t){this._super(e,t),this.minItemsCount=this.itemsHolder.attr("data-min-items-count")},initLastIndex:function(){this.lastIndexInput=this.itemsHolder.find(">tfoot .mphb-complex-last-index"),this.lastIndex=this.lastIndexInput.val()},getIncIndex:function(){var e=this._super();return this.lastIndexInput.val(e),e},initItemsHolder:function(){this.itemsHolder=this.element.children("table")},addItemToHolder:function(e){this.itemsHolder.children("tfoot").before(e)},disableDeleteButtons:function(){this.itemsHolder.children(this.itemSelector).children(".mphb-complex-item-actions-holder").find(".mphb-complex-delete-item").attr("disabled","disabled").addClass("mphb-hide")},enableDeleteButtons:function(){this.itemsHolder.children(this.itemSelector).children(".mphb-complex-item-actions-holder").find(".mphb-complex-delete-item").removeAttr("disabled").removeClass("mphb-hide")},updateItemActions:function(){this.itemsHolder.children(this.itemSelector).length<=this.minItemsCount?this.disableDeleteButtons():this.enableDeleteButtons()},updateDefaultItem:function(){var e=this.itemsHolder.children(this.itemSelector).find('>.mphb-complex-item-actions-holder [name="'+this.metaName+'[default]"]');e.filter(":checked").length||e.first().attr("checked","checked")},deleteItem:function(e){this._super(e),this.updateItemActions(),this.updateDefaultItem()},addItem:function(){this._super(),this.updateItemActions(),this.updateDefaultItem()}}),MPHB.DatePickerCtrl=MPHB.Ctrl.extend({renderValue:function(e){return e.find('input[type="text"]').val()}},{input:null,hiddenInput:null,init:function(e,t){if(this._super(e,t),this.input=this.element.find('input[type="text"]'),this.hiddenInput=this.element.find('input[type="hidden"]'),this.fixDate(),this.input.attr("readonly")||this.input.datepick({dateFormat:MPHB.Plugin.myThis.data.settings.dateFormat,altField:this.hiddenInput,altFormat:MPHB.Plugin.myThis.data.settings.dateTransferFormat,showSpeed:0,showOtherMonths:!1,monthsToShow:MPHB.Plugin.myThis.data.settings.numberOfMonthDatepicker,pickerClass:MPHB.Plugin.myThis.data.settings.datepickerClass}),!this.input.attr("required")){var i=this.hiddenInput;this.input.on("change",function(){""==p(this).val()&&i.val("")})}},fixDate:function(){if(this.hiddenInput.val()){var e=p.datepick.parseDate(MPHB.Plugin.myThis.data.settings.dateTransferFormat,this.hiddenInput.val()),t=p.datepick.formatDate(MPHB.Plugin.myThis.data.settings.dateFormat,e);this.input.val(t)}else;}}),MPHB.DynamicSelectCtrl=MPHB.Ctrl.extend({},{input:null,dependencyCtrl:null,ajaxAction:null,ajaxNonce:null,errorsWrapper:null,preloader:null,defaultValue:null,defaultOption:null,complexId:null,group:"",init:function(e,t){this._super(e,t),this.input=this.element.find("select"),this.defaultValue=this.input.attr("data-default"),this.defaultOption=this.input.find('option[value="'+this.defaultValue+'"]').clone(),this.errorsWrapper=this.element.find(".mphb-errors-wrapper"),this.preloader=this.element.find(".mphb-preloader"),this.ajaxAction=this.input.attr("data-ajax-action"),this.ajaxNonce=this.input.attr("data-ajax-nonce"),this.initDependencyCtrl(),this.initComplexId(),this.initGroup()},initDependencyCtrl:function(){var e=this.input.attr("data-dependency");this.dependencyCtrl=this.element.closest("form").find('[name="'+e+'"]');var t=this;this.dependencyCtrl.on("change",function(e){t.updateList()}).on("focus",function(e){t.hideErrors()})},initComplexId:function(){var e=this.element.parents("tr[data-id]");0<e.length&&(this.complexId=parseInt(e.attr("data-id")))},initGroup:function(){var e=this.element.parents(".mphb-ctrl-rules-list");0<e.length&&(this.group=e.attr("data-group"))},setOptions:function(e){var i=this;this.input.html(this.defaultOption.clone()),p.each(e,function(e,t){i.input.append(p("<option />",{value:e,html:t}))})},updateList:function(){var t=this;this.hideErrors(),this.showPreloader(),this.input.html(this.defaultOption.clone());var e={action:this.ajaxAction,mphb_nonce:this.ajaxNonce,formValues:this.parseFormToJSON()};p.ajax({url:MPHB.Plugin.myThis.data.ajaxUrl,type:"GET",dataType:"json",data:e,success:function(e){e.hasOwnProperty("success")?e.success?t.setOptions(e.data.options):t.showError(e.data.message):t.showError(MPHB.Plugin.myThis.data.translations.errorHasOccured)},error:function(e){t.showError(MPHB.Plugin.myThis.data.translations.errorHasOccured)},complete:function(e){t.hidePreloader()}})},parseFormToJSON:function(){var e=this.parentForm.serializeJSON();return""!=this.group&&(e=e[this.group]),null!=this.complexId&&(e=e[this.complexId]),e},showPreloader:function(){this.preloader.removeClass("mphb-hide")},hidePreloader:function(){this.preloader.addClass("mphb-hide")},hideErrors:function(){this.errorsWrapper.empty().addClass("mphb-hide")},showError:function(e){this.errorsWrapper.html(e).removeClass("mphb-hide")}}),MPHB.GalleryCtrl=MPHB.Ctrl.extend({},{input:null,previewHolder:null,addGalleryBtn:null,removeGalleryBtn:null,init:function(e,t){this._super(e,t),this.input=this.element.find("input[type=hidden]"),this.previewHolder=this.element.find("img").on("click",this.proxy("organizeGallery")),this.addGalleryBtn=this.element.find(".mphb-admin-organize-gallery-add").on("click",this.proxy("organizeGallery")),this.removeGalleryBtn=this.element.find(".mphb-admin-organize-gallery-remove").on("click",this.proxy("removeGallery"))},get:function(){return this.input.val()},getArray:function(){return""!==this.get()?this.get().split(/,/):[]},set:function(e){this.input.val(e),this.updatePreview(),this.updateBtnsVisibility()},updateBtnsVisibility:function(){""!==this.get()?(this.removeGalleryBtn.removeClass("mphb-hide"),this.addGalleryBtn.addClass("mphb-hide")):(this.removeGalleryBtn.addClass("mphb-hide"),this.addGalleryBtn.removeClass("mphb-hide"))},updatePreview:function(){var e=this.get();if(""!==e){var t=e.split(",").shift(),i=wp.media.attachment(t).attributes.sizes.medium.url;this.previewHolder.removeClass("mphb-hide").attr("src",i)}else this.previewHolder.addClass("mphb-hide").attr("src","")},organizeGallery:function(e){e.preventDefault(),MPHB.WPGallery.getInstance().open(this)},removeGallery:function(e){e.preventDefault(),this.set("")}}),MPHB.MultipleCheckboxCtrl=MPHB.Ctrl.extend({renderValue:function(e){var t=e.find('input[type="checkbox"]'),i=t.filter(".mphb-checkbox-all:checked"),n=t.filter(":checked");if(0<i.length||n.length==t.length)return MPHB.Plugin.myThis.data.translations.all;var r=[];return n.each(function(){var e=p(this).parent().text();r.push(e)}),0<r.length?r.join(", "):MPHB.Plugin.myThis.data.translations.none}},{checkboxes:null,selectAllCheckbox:null,init:function(e,t){this._super(e,t),this.checkboxes=this.element.find('input[type="checkbox"]:not(.mphb-checkbox-all)'),this.selectAllCheckbox=this.element.find('input[type="checkbox"].mphb-checkbox-all'),this.selectAllCheckbox.prop("checked")&&this.disableCheckboxes()},".mphb-checkbox-all click":function(){this.selectAllCheckbox.prop("checked")?(this.disableCheckboxes(),this.selectCheckboxes()):this.enableCheckboxes()},".mphb-checkbox-select-all click":function(e,t){t.preventDefault(),this.selectCheckboxes()},".mphb-checkbox-unselect-all click":function(e,t){t.preventDefault(),this.unselectAll(),this.enableCheckboxes()},disableCheckboxes:function(){this.checkboxes.prop("disabled",!0)},enableCheckboxes:function(){this.checkboxes.prop("disabled",!1)},selectCheckboxes:function(){this.checkboxes.prop("checked",!0)},unselectCheckboxes:function(){this.checkboxes.prop("checked",!1)},unselectAll:function(){this.selectAllCheckbox.prop("checked",!1),this.unselectCheckboxes()}}),MPHB.NumberCtrl=MPHB.Ctrl.extend({renderValue:function(e){var t=e.children('input[type="number"]');return t.val()+t.parent().text()}},{input:null,disableOn:[],init:function(e,t){this._super(e,t),this.input=this.element.children("[name]");var i=this.input.attr("data-dependency"),n=this.input.attr("data-disable-on");if(i&&n){this.disableOn=n.split(",");var r=this;this.element.closest("form").find('[name="'+i+'"]').on("change",function(e){var t=p(this).val();r.onDependencyChange(t)})}},onDependencyChange:function(e){-1!=this.disableOn.indexOf(e)?this.input.prop("disabled",!0):this.input.prop("disabled",!1)}}),MPHB.PriceBreakdownCtrl=MPHB.Ctrl.extend({},{".mphb-price-breakdown-expand click":function(e,t){t.preventDefault(),p(e).blur();var i=p(e).parents("tr.mphb-price-breakdown-group");i.find(".mphb-price-breakdown-rate").toggleClass("mphb-hide"),i.nextUntil("tr.mphb-price-breakdown-group").toggleClass("mphb-hide")}}),MPHB.RulesListCtrl=MPHB.Ctrl.extend({},{editClass:"mphb-rules-list-editing",editText:"",doneText:"",lastIndex:-1,rulesCount:0,table:null,tbody:null,rulePrototype:null,editingRule:null,noRulesMessage:null,prependNewItems:!1,init:function(e,t){this._super(e,t),this.editText=MPHB.Plugin.myThis.data.translations.edit,this.doneText=MPHB.Plugin.myThis.data.translations.done,this.noRulesMessage=e.find(".mphb-rules-list-empty-message"),this.table=e.children("table"),this.tbody=this.table.children("tbody"),this.tbody.hasClass("mphb-sortable")&&(this.tbody.sortable(),this.prependNewItems=!0);var i=this.tbody.children(".mphb-rules-list-prototype"),n=i.clone();i.remove(),n.removeClass("mphb-rules-list-prototype mphb-hide"),n.find(".mphb-ctrl:not(.mphb-keep-disabled) [name]:not(.mphb-keep-disabled)").each(function(){p(this).prop("disabled",!1)}),this.rulePrototype=n;var r=this.tbody.children("tr"),a=this.lastIndex;r.each(function(){var e=parseInt(p(this).attr("data-id"));a=Math.max(a,e)}),this.lastIndex=a,this.rulesCount=r.length},".mphb-rules-list-add-button click":function(){this.addRule()},".mphb-rules-list-edit-button click":function(e,t){var i=this.getRuleByButton(e);this.toggleEdit(i)},".mphb-rules-list-delete-button click":function(e,t){var i=this.getRuleByButton(e);this.deleteRule(i)},addRule:function(){var e=this.rulePrototype.clone(),n=this.nextIndex();e.attr("data-id",n),e.find('[name*="[$index$]"]').each(function(){var e=p(this),t=e.attr("name");t=t.replace("$index$",n),e.attr("name",t);var i=e.attr("id");i&&(i=i.replace("$index$",n),e.attr("id",i))}),e.find('[data-dependency*="[$index$]"]').each(function(){var e=p(this),t=e.attr("data-dependency");t=t.replace("$index$",n),e.attr("data-dependency",t)}),this.prependNewItems?this.tbody.prepend(e):this.tbody.append(e),this.increaseRulesCount();var t=e.find(".mphb-ctrl:not([data-inited])");MPHB.Plugin.myThis.setControls(t),this.toggleEdit(e)},toggleEdit:function(e){null!=this.editingRule&&(this.renderValues(this.editingRule),this.editingRule.removeClass(this.editClass),this.editingRule.find(".mphb-rules-list-edit-button").text(this.editText)),this.isEditingRule(e)?this.editingRule=null:((this.editingRule=e).addClass(this.editClass),e.find(".mphb-rules-list-edit-button").text(this.doneText))},deleteRule:function(e){this.isEditingRule(e)&&(this.editingRule=null),e.remove(),this.decreaseRulesCount()},isEditingRule:function(e){return null!=this.editingRule&&e[0]===this.editingRule[0]},getRuleByButton:function(e){return e.closest("tr")},increaseRulesCount:function(){0==this.rulesCount&&(this.noRulesMessage.addClass("mphb-hide"),this.table.removeClass("mphb-hide")),this.rulesCount++},decreaseRulesCount:function(){this.rulesCount--,0==this.rulesCount&&(this.table.addClass("mphb-hide"),this.noRulesMessage.removeClass("mphb-hide"))},nextIndex:function(){return this.lastIndex++,this.lastIndex},renderValues:function(e){var n=this;e.children("td").each(function(){var e=p(this),t=e.children(".mphb-ctrl");if(0!=t.length){var i=n.renderValue(t);e.children(".mphb-rules-list-rendered-value").html(i)}})},renderValue:function(e){var t="";switch(e.attr("data-type")){case"text":t=MPHB.Ctrl.renderValue(e);break;case"datepicker":t=MPHB.DatePickerCtrl.renderValue(e);break;case"textarea":t=e.find("textarea").val();break;case"number":t=MPHB.NumberCtrl.renderValue(e);break;case"select":case"dynamic-select":var i=e.children("select"),n=i.val();if(null!=n)t=i.children('option[value="'+n+'"]').text();else t=MPHB.Plugin.myThis.data.translations.none;break;case"multiple-checkbox":t=MPHB.MultipleCheckboxCtrl.renderValue(e);break;case"amount":t=MPHB.AmountCtrl.renderValue(e);break;case"placeholder":t="-"}return t}}),MPHB.TotalPriceCtrl=MPHB.Ctrl.extend({},{preloader:null,input:null,init:function(e,t){this._super(e,t),this.input=this.element.find("input"),this.recalculateBtn=this.element.find("#mphb-recalculate-total-price"),this.errorsWrapper=this.element.find(".mphb-errors-wrapper"),this.preloader=this.element.find(".mphb-preloader")},set:function(e){this.input.val(e)},hideErrors:function(){this.errorsWrapper.empty().addClass("mphb-hide")},"input focus":function(){this.hideErrors()},showError:function(e){this.errorsWrapper.html(e).removeClass("mphb-hide")},"#mphb-recalculate-total-price click":function(e,t){var n=this;this.hideErrors(),this.showPreloader();var i=this.parseFormToJSON();p.ajax({url:MPHB.Plugin.myThis.data.ajaxUrl,type:"POST",dataType:"json",data:{action:"mphb_recalculate_total",mphb_nonce:MPHB.Plugin.myThis.data.nonces.mphb_recalculate_total,formValues:i},success:function(e){if(e.hasOwnProperty("success"))if(e.success){n.set(e.data.total);var t=n.element.closest("form").find('[name="_mphb_booking_price_breakdown"]'),i=t.siblings(".mphb-price-breakdown-wrapper");t.val(e.data.price_breakdown),t.prop("disabled",!1),i.html(e.data.price_breakdown_html)}else n.showError(e.data.message);else n.showError(MPHB.Plugin.myThis.data.translations.errorHasOccured)},error:function(e){n.showError(MPHB.Plugin.myThis.data.translations.errorHasOccured)},complete:function(e){n.hidePreloader()}})},showPreloader:function(){this.recalculateBtn.attr("disabled","disabled"),this.preloader.removeClass("mphb-hide")},hidePreloader:function(){this.recalculateBtn.removeAttr("disabled"),this.preloader.addClass("mphb-hide")},parseFormToJSON:function(){return this.parentForm.serializeJSON()}}),MPHB.VariablePricingCtrl=MPHB.Ctrl.extend({},{MIN_PERIOD:2,name:"",periodsTable:null,variationsTable:null,variationsTableBody:null,variationsTableFooter:null,afterPeriods:null,afterPrices:null,pricesHeaders:null,template:null,templateActions:null,lastIndex:-1,lastPeriodIndex:-1,periodsCount:0,removePeriodText:"",upgradeToPremiumMessageHtml:"",init:function(e,t){this._super(e,t),this.name=e.children(".mphb-pricing-name-holder").attr("name"),this.removePeriodText=MPHB.Plugin.myThis.data.translations.removePeriod,this.upgradeToPremiumMessageHtml=MPHB.Plugin.myThis.data.settings.upgradeToPremiumMsgHtml,this.periodsTable=e.children(".mphb-pricing-periods-table"),this.variationsTable=e.children(".mphb-pricing-variations-table"),this.variationsTableBody=this.variationsTable.children("tbody"),this.variationsTableFooter=this.variationsTable.find("tfoot > tr > td"),this.afterPeriods=this.periodsTable.find("> tbody > tr:first-child > td:last-child"),this.afterPrices=this.periodsTable.find("> tbody > tr:last-child > td:last-child"),this.pricesHeaders=e.find(".mphb-pricing-price-per-night"),this.template=this.loadTemplate(),this.templateActions=this.template.children("td:last-child"),this.lastIndex=this.findLastIndex(),this.lastPeriodIndex=this.findLastPeriodIndex(),this.periodsCount=this.findPeriodsCount(),this.watchCheckbox()},loadTemplate:function(){var e=this.variationsTable.find(".mphb-pricing-variation-template"),t=e.clone();return e.remove(),t.removeClass("mphb-pricing-variation-prototype mphb-hide"),t.find("[name]").each(function(){-1==p(this).attr("name").indexOf("[prices]")&&p(this).prop("disabled",!1)}),t},addVariation:function(){var e=this.template.clone(),i=this.nextIndex();e.attr("data-index",i),e.find('[name*="[$index$]"]').each(function(){var e=p(this),t=e.attr("name");t=t.replace("$index$",i),e.attr("name",t)}),this.variationsTableBody.append(e)},removeVariation:function(e){e.remove()},addPeriod:function(){var e=this.nextPeriodIndex(),t='<input type="number" name="'+this.name+'[periods][]" class="small-text" value="'+this.MIN_PERIOD+'" min="'+this.MIN_PERIOD+'" step="1" />';t='<td data-period-index="'+e+'">'+(t+='<br /><span class="dashicons dashicons-trash mphb-pricing-action mphb-pricing-remove-period" title="'+this.removePeriodText+'"></span>')+"</td>";var i=' disabled="disabled"',n="<br />"+this.upgradeToPremiumMessageHtml,r='<td data-period-index="'+e+'"><input type="text" name="'+this.name+'[prices][]" class="mphb-price-text" value=""'+i+" />"+n+"</td>",a='<td data-period-index="'+e+'"><input type="text" name="'+this.name+'[variations][$index$][prices][]" class="mphb-price-text" value=""'+i+" />"+n+"</td>";this.afterPeriods.before(t),this.afterPrices.before(r),this.templateActions.before(a),this.variationsTableBody.children("tr").each(function(e,t){var i=p(t);e=parseInt(i.attr("data-index"));i.children("td:last-child").before(a.replace("$index$",e))}),this.increasePeriodsCount()},removePeriod:function(e){this.template.find('[data-period-index="'+e+'"]').remove(),this.element.find('[data-period-index="'+e+'"]').remove(),this.decreasePeriodsCount()},nextIndex:function(){return this.lastIndex++,this.lastIndex},nextPeriodIndex:function(){return this.lastPeriodIndex++,this.lastPeriodIndex},findLastIndex:function(){var e=this.variationsTableBody.children("tr"),t=-1;return e.each(function(){var e=parseInt(p(this).attr("data-index"));t=Math.max(t,e)}),t},findLastPeriodIndex:function(){var e=this.periodsTable.find("> tbody > tr:first-child > td[data-period-index]"),t=-1;return e.each(function(){var e=parseInt(p(this).attr("data-period-index"));t=Math.max(t,e)}),t},findPeriodsCount:function(){return this.periodsTable.find("> tbody > tr:first-child > td[data-period-index]").length},increasePeriodsCount:function(){this.periodsCount++,this.updateColspans()},decreasePeriodsCount:function(){this.periodsCount--,this.updateColspans()},updateColspans:function(){this.pricesHeaders.attr("colspan",this.periodsCount),this.variationsTableFooter.attr("colspan",this.periodsCount+3)},watchCheckbox:function(){var t=this;this.element.find(".mphb-pricing-enable-variations").on("change",function(e){t.variationsTable.toggleClass("mphb-hide")})},".mphb-pricing-add-variation click":function(e,t){this.addVariation()},".mphb-pricing-remove-variation click":function(e,t){var i=e.closest("tr");this.removeVariation(i)},".mphb-pricing-add-period click":function(e,t){this.addPeriod()},".mphb-pricing-remove-period click":function(e,t){var i=e.closest("td").attr("data-period-index");this.removePeriod(i)}}),new MPHB.Plugin,p(function(){p(".mphb-bookings-calendar-wrapper")&&new MPHB.BookingsCalendar(p(".mphb-bookings-calendar-wrapper"))})})}(jQuery);